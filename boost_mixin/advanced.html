<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<title>Advanced topics</title>
<link rel="stylesheet" href="../boostbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.76.1">
<link rel="home" href="../index.html" title="Chapter&#160;1.&#160;Boost.Mixin 0.1">
<link rel="up" href="../index.html" title="Chapter&#160;1.&#160;Boost.Mixin 0.1">
<link rel="prev" href="examples.html" title="Examples">
<link rel="next" href="../mixin/reference.html" title="Reference">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="spirit-nav">
<a accesskey="p" href="examples.html"><img src="../images/prev.png" alt="Prev"></a><a accesskey="u" href="../index.html"><img src="../images/up.png" alt="Up"></a><a accesskey="h" href="../index.html"><img src="../images/home.png" alt="Home"></a><a accesskey="n" href="../mixin/reference.html"><img src="../images/next.png" alt="Next"></a>
</div>
<div class="section">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="boost_mixin.advanced"></a><a class="link" href="advanced.html" title="Advanced topics">Advanced topics</a>
</h2></div></div></div>
<div class="toc"><dl>
<dt><span class="section"><a href="advanced.html#boost_mixin.advanced.performance">Performance</a></span></dt>
<dt><span class="section"><a href="advanced.html#boost_mixin.advanced.allocators">Using custom allocators</a></span></dt>
<dt><span class="section"><a href="advanced.html#boost_mixin.advanced.dynlib">Dynamic libraries and program
      plugins</a></span></dt>
</dl></div>
<div class="section">
<div class="titlepage"><div><div><h3 class="title">
<a name="boost_mixin.advanced.performance"></a><a class="link" href="advanced.html#boost_mixin.advanced.performance" title="Performance">Performance</a>
</h3></div></div></div>
<p>
        <a class="indexterm" name="idp6769552"></a>
      </p>
<div class="section">
<div class="titlepage"><div><div><h4 class="title">
<a name="boost_mixin.advanced.performance.msg_perf"></a><a class="link" href="advanced.html#boost_mixin.advanced.performance.msg_perf" title="Message performance">Message
        performance</a>
</h4></div></div></div>
<p>
          <a class="indexterm" name="idp6772528"></a>
        </p>
<p>
          The performance of messages is indeed slower than regular function calls
          and even virtual function calls. Even though a call's algorithmic complexity
          is still O(1), a number of memory indirections happen in order to call
          the actual method behind the message.
        </p>
<p>
          Unfortunately it's hard to estimate exactly how much slower the message
          call is. With perfect cache locality and compiler optimizations a message
          call will take about 15 cycles, compared to about 5-7 cycles for a virtual
          call and 10-12 cycles for a std::function call. 15 cycles on a modern 2.8
          GHz processor take about 5 nanoseconds to execute, which is a negligible
          cost for a call.
        </p>
<p>
          Unfortunately perfect cache locality is hard to come by, and especially
          hard in polymorphic code. In an amortized test with potential cache misses
          for all calls, Boost.Mixin messages take on average about 120 cycles (40
          nanoseconds on the same processor), compared to 90 cycles on average for
          virtual calls and 115 cycles for a <code class="computeroutput"><span class="identifier">std</span><span class="special">::</span><span class="identifier">function</span></code>
          call.
        </p>
<p>
          So, generally speaking if the programmer doesn't take special care to achieve
          cache locality for their object lists, a message call is about 2 times
          slower than a regular method call and about 1.3 times slower than a virtual
          call and abotut as fast as a <code class="computeroutput"><span class="identifier">std</span><span class="special">::</span><span class="identifier">function</span></code>
          call, which again can be called negligible.
        </p>
<p>
          As, we've mentionet before if cache locality is an absolutely critical
          feature for the desired performance, mixin messages, virtual calls, <code class="computeroutput"><span class="identifier">std</span><span class="special">::</span><span class="identifier">function</span></code>, and other types of polymorphism
          will almost certainly be detrimental for this code, and the programmers
          are advised to do something else.
        </p>
<div class="section">
<div class="titlepage"><div><div><h5 class="title">
<a name="boost_mixin.advanced.performance.msg_perf.msg_perf_test"></a><a class="link" href="advanced.html#boost_mixin.advanced.performance.msg_perf.msg_perf_test" title="Message performance test">Message
          performance test</a>
</h5></div></div></div>
<p>
            The message performance test compares regular method calls vs virtual
            method calls vs <code class="computeroutput"><span class="identifier">std</span><span class="special">::</span><span class="identifier">function</span></code> calls vs Boost.Mixin unicast
            message calls.
          </p>
<p>
            It creates 10,000 objects, then processes them until 100,000,000 calls
            are made. The actuall calls perform a simple adition whose cost compared
            with the call cost is indeed negligible.
          </p>
<p>
            The regular method calls are what you would have in cache-locality optimized
            setting &#8211; they are methods in an array of objects of the the same
            type stored by value.
          </p>
<p>
            The other calls are polymorphic and their arrays store objects by address
            that can be one of two types.
          </p>
<p>
            Here are some test results:
          </p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem">
                OS: Ubuntu 13.04
              </li>
<li class="listitem">
                CPU: AMD FX X8 8150
              </li>
<li class="listitem">
                Compiler: g++ (Ubuntu/Linaro 4.7.3-1ubuntu1)
              </li>
<li class="listitem">
                Debug compilation parameters: <code class="computeroutput"><span class="special">-</span><span class="identifier">fexceptions</span> <span class="special">-</span><span class="identifier">g</span></code>
              </li>
<li class="listitem">
                Release compilation parameters <code class="computeroutput"><span class="special">-</span><span class="identifier">fexceptions</span> <span class="special">-</span><span class="identifier">O2</span></code>
              </li>
</ul></div>
<div class="informaltable"><table class="table">
<colgroup>
<col>
<col>
<col>
<col>
<col>
</colgroup>
<thead><tr>
<th>
                    <p>
                      Method
                    </p>
                  </th>
<th>
                    <p>
                      Debug
                    </p>
                  </th>
<th>
                    <p>
                      Debug mean
                    </p>
                  </th>
<th>
                    <p>
                      Release
                    </p>
                  </th>
<th>
                    <p>
                      Release mean
                    </p>
                  </th>
</tr></thead>
<tbody>
<tr>
<td>
                    <p>
                      Regular
                    </p>
                  </td>
<td>
                    <p>
                      2345 ms
                    </p>
                  </td>
<td>
                    <p>
                      23 ns
                    </p>
                  </td>
<td>
                    <p>
                      1088 ms
                    </p>
                  </td>
<td>
                    <p>
                      11 ns
                    </p>
                  </td>
</tr>
<tr>
<td>
                    <p>
                      Virtual
                    </p>
                  </td>
<td>
                    <p>
                      2894 ms
                    </p>
                  </td>
<td>
                    <p>
                      29 ns
                    </p>
                  </td>
<td>
                    <p>
                      1580 ms
                    </p>
                  </td>
<td>
                    <p>
                      16 ns
                    </p>
                  </td>
</tr>
<tr>
<td>
                    <p>
                      <code class="computeroutput"><span class="identifier">std</span><span class="special">::</span><span class="identifier">function</span></code>
                    </p>
                  </td>
<td>
                    <p>
                      11910 ms
                    </p>
                  </td>
<td>
                    <p>
                      119 ns
                    </p>
                  </td>
<td>
                    <p>
                      1966 ms
                    </p>
                  </td>
<td>
                    <p>
                      20 ns
                    </p>
                  </td>
</tr>
<tr>
<td>
                    <p>
                      Boost.Mixin msg
                    </p>
                  </td>
<td>
                    <p>
                      4942 ms
                    </p>
                  </td>
<td>
                    <p>
                      50 ns
                    </p>
                  </td>
<td>
                    <p>
                      1986 ms
                    </p>
                  </td>
<td>
                    <p>
                      20 ns
                    </p>
                  </td>
</tr>
</tbody>
</table></div>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem">
                OS: Windows 7
              </li>
<li class="listitem">
                CPU: AMD FX 4100
              </li>
<li class="listitem">
                Compiler: msvc 9 (Visual Studio 2008)
              </li>
<li class="listitem">
                Debug compilation parameters: Standard (<code class="computeroutput"><span class="special">/</span><span class="identifier">Od</span> <span class="special">/</span><span class="identifier">EHsc</span> <span class="special">/</span><span class="identifier">RTC1</span> <span class="special">/</span><span class="identifier">MDd</span> <span class="special">/</span><span class="identifier">ZI</span></code>)
              </li>
<li class="listitem">
                Release compilation parameters: Standard, but with no link time code
                generation (<code class="computeroutput"><span class="special">/</span><span class="identifier">O2</span>
                <span class="special">/</span><span class="identifier">Oi</span>
                <span class="special">/</span><span class="identifier">EHsc</span>
                <span class="special">/</span><span class="identifier">MD</span>
                <span class="special">/</span><span class="identifier">Gy</span>
                <span class="special">/</span><span class="identifier">Zi</span></code>)
              </li>
</ul></div>
<div class="informaltable"><table class="table">
<colgroup>
<col>
<col>
<col>
<col>
<col>
</colgroup>
<thead><tr>
<th>
                    <p>
                      Method
                    </p>
                  </th>
<th>
                    <p>
                      Debug
                    </p>
                  </th>
<th>
                    <p>
                      Debug mean
                    </p>
                  </th>
<th>
                    <p>
                      Release
                    </p>
                  </th>
<th>
                    <p>
                      Release mean
                    </p>
                  </th>
</tr></thead>
<tbody>
<tr>
<td>
                    <p>
                      Regular
                    </p>
                  </td>
<td>
                    <p>
                      4103 ms
                    </p>
                  </td>
<td>
                    <p>
                      41 ns
                    </p>
                  </td>
<td>
                    <p>
                      1419 ms
                    </p>
                  </td>
<td>
                    <p>
                      14 ns
                    </p>
                  </td>
</tr>
<tr>
<td>
                    <p>
                      Virtual
                    </p>
                  </td>
<td>
                    <p>
                      5585 ms
                    </p>
                  </td>
<td>
                    <p>
                      55 ns
                    </p>
                  </td>
<td>
                    <p>
                      1560 ms
                    </p>
                  </td>
<td>
                    <p>
                      16 ns
                    </p>
                  </td>
</tr>
<tr>
<td>
                    <p>
                      <code class="computeroutput"><span class="identifier">boost</span><span class="special">::</span><span class="identifier">function</span></code>
                    </p>
                  </td>
<td>
                    <p>
                      45240 ms
                    </p>
                  </td>
<td>
                    <p>
                      452 ns
                    </p>
                  </td>
<td>
                    <p>
                      1919 ms
                    </p>
                  </td>
<td>
                    <p>
                      19 ns
                    </p>
                  </td>
</tr>
<tr>
<td>
                    <p>
                      Boost.Mixin msg
                    </p>
                  </td>
<td>
                    <p>
                      25100 ms
                    </p>
                  </td>
<td>
                    <p>
                      251 ns
                    </p>
                  </td>
<td>
                    <p>
                      2714 ms
                    </p>
                  </td>
<td>
                    <p>
                      27 ns
                    </p>
                  </td>
</tr>
</tbody>
</table></div>
</div>
<div class="section">
<div class="titlepage"><div><div><h5 class="title">
<a name="boost_mixin.advanced.performance.msg_perf.optimize_msg"></a><a class="link" href="advanced.html#boost_mixin.advanced.performance.msg_perf.optimize_msg" title="Optimizing message calls">Optimizing
          message calls</a>
</h5></div></div></div>
<p>
            The stand-alone functions generated for messages typically have an <code class="computeroutput"><span class="keyword">if</span></code> statement in them. It's there so as
            to throw an exception if none of the mixins in an object implements the
            message. If you disable the library's exceptions those <code class="computeroutput"><span class="keyword">if</span></code>-s will be converted to <code class="computeroutput"><span class="identifier">assert</span></code>-s (which in non-debug compilations
            are simply ignored).
          </p>
<p>
            If you don't want to recompile the library with exceptions disabled,
            or if you just want all other exceptions, but not these, you can disable
            the throwing of exceptions from the message functions fi you define
            <code class="computeroutput"><span class="identifier">BOOST_MIXIN_NO_MSG_THROW</span></code>
            <span class="emphasis"><em>before</em></span> including the Boost.Mixin headers.
          </p>
<p>
            Note that if you disable the exceptions from the message functions, calling
            a message on an object that doesn't implement it, will certainly lead
            to undefined behaviour and crashes.
          </p>
<p>
            Also have in mind, that removing the 'if'-s will improve the performance
            by only a small amount of nanoseconds per message call on a modern CPU.
            Situations where such a thing could be significant should be very very
            rare.
          </p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title">
<a name="boost_mixin.advanced.performance.mutation_perf"></a><a class="link" href="advanced.html#boost_mixin.advanced.performance.mutation_perf" title="Mutation performance">Mutation
        performance</a>
</h4></div></div></div></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title">
<a name="boost_mixin.advanced.allocators"></a><a class="link" href="advanced.html#boost_mixin.advanced.allocators" title="Using custom allocators">Using custom allocators</a>
</h3></div></div></div></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title">
<a name="boost_mixin.advanced.dynlib"></a><a class="link" href="advanced.html#boost_mixin.advanced.dynlib" title="Dynamic libraries and program plugins">Dynamic libraries and program
      plugins</a>
</h3></div></div></div></div>
</div>
<table xmlns:rev="http://www.cs.rpi.edu/~gregod/boost/tools/doc/revision" width="100%"><tr>
<td align="left"></td>
<td align="right"><div class="copyright-footer">Copyright &#169; 2013, 2014 Borislav Stanimirov, Zahary Karadjov<p>
        Distributed under the Boost Software License, Version 1.0. (See accompanying
        file LICENSE_1_0.txt or copy at <a href="http://www.boost.org/LICENSE_1_0.txt" target="_top">http://www.boost.org/LICENSE_1_0.txt</a>).
      </p>
</div></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="examples.html"><img src="../images/prev.png" alt="Prev"></a><a accesskey="u" href="../index.html"><img src="../images/up.png" alt="Up"></a><a accesskey="h" href="../index.html"><img src="../images/home.png" alt="Home"></a><a accesskey="n" href="../mixin/reference.html"><img src="../images/next.png" alt="Next"></a>
</div>
</body>
</html>
